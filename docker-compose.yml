# KiroGate - 服务器部署配置
#
# 使用方法:
#   1. 配置下方环境变量
#   2. docker compose up -d

services:
  kirogate:
    image: ghcr.io/sortbyiky/kirogate:latest
    container_name: kirogate
    restart: unless-stopped
    ports:
      - "8000:8000"
    environment:
      # 代理 API 密钥（客户端连接时使用）
      - PROXY_API_KEY=${PROXY_API_KEY:-sk-kirogate-change-me}

      # Kiro 账号 Refresh Token（多个用逗号分隔）
      - REFRESH_TOKEN=${REFRESH_TOKEN}

      # 服务端口
      - PORT=8000

      # 日志级别: DEBUG / INFO / WARN / ERROR
      - LOG_LEVEL=${LOG_LEVEL:-INFO}

      # 每分钟请求限制（0 = 不限制）
      - RATE_LIMIT=${RATE_LIMIT:-0}

      # 管理面板密码（留空则禁用面板）
      - ADMIN_PASSWORD=${ADMIN_PASSWORD:-}

      # 上下文压缩阈值（token 数，0 = 禁用）
      - COMPRESS_THRESHOLD=${COMPRESS_THRESHOLD:-0}
    volumes:
      # 持久化 Deno KV 数据
      - /opt/kirogate/data:/app/data
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
